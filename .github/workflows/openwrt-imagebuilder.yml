name: build-openwrt-x86_64

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Install tools
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y ca-certificates curl wget jq zstd
          sudo ln -sf /usr/bin/sha256sum /usr/local/bin/sha256

      - name: Download ImageBuilder
        run: |
          set -euo pipefail
          VER=24.10.5
          IB_TMP="openwrt-imagebuilder-${VER}-x86-64.Linux-x86_64"
          URL="https://downloads.openwrt.org/releases/${VER}/targets/x86/64/${IB_TMP}.tar.zst"
          echo "IB_DIR=${IB_TMP}" >> "$GITHUB_ENV"
          curl -fL --retry 5 --retry-delay 3 -o ib.tar.zst "$URL"
          tar --zstd -xf ib.tar.zst

      - name: Download OpenClash ipk
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          API="https://api.github.com/repos/vernesong/OpenClash/releases?per_page=30"
          OC_URL="$(curl -fsSL \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "$API" \
            | jq -r 'first(.[].assets[]? | select(.name|test("^luci-app-openclash_.*_all\\.ipk$")) | .browser_download_url)')"
          test -n "$OC_URL"
          test "$OC_URL" != "null"
          curl -fL --retry 5 --retry-delay 3 -o luci-app-openclash.ipk "$OC_URL"
          test -s luci-app-openclash.ipk

      - name: Build firmware
        run: |
          set -euo pipefail
          cd "$IB_DIR"

          PKGS="luci luci-base luci-ssl luci-app-uhttpd luci-app-firewall luci-app-package-manager luci-theme-bootstrap luci-compat luci-i18n-base-zh-cn luci-i18n-firewall-zh-cn luci-i18n-package-manager-zh-cn luci-i18n-uhttpd-zh-cn ppp ppp-mod-pppoe luci-proto-ppp luci-proto-ipv6 odhcp6c odhcpd-ipv6only dnsmasq-full -dnsmasq coreutils-nohup bash curl ca-bundle ca-certificates ip-full ipset iptables iptables-nft iptables-mod-tproxy iptables-mod-extra kmod-tun kmod-inet-diag kmod-nft-tproxy ruby ruby-yaml jq unzip kmod-wireguard wireguard-tools luci-proto-wireguard qrencode ddns-scripts ddns-scripts-services ddns-scripts-cloudflare luci-app-ddns luci-i18n-ddns-zh-cn speedtest-go speedtest-netperf netperf fping mtr-json iperf3 collectd luci-app-statistics collectd-mod-ping collectd-mod-curl luci-i18n-statistics-zh-cn luci-app-nlbwmon luci-i18n-nlbwmon-zh-cn luci-app-vnstat2 vnstat2 vnstati2 luci-i18n-vnstat2-zh-cn libcap libcap-bin"

          make image PROFILE=generic ROOTFS_PARTSIZE=2048 \
            PACKAGES="$PKGS ../luci-app-openclash.ipk" V=s 2>&1 | tee /tmp/build.log

      - name: Verify manifest (hard check)
        run: |
          set -euo pipefail
          MANIFEST="$(ls "$IB_DIR"/bin/targets/x86/64/*manifest | head -n1)"
          for p in \
            luci luci-base luci-ssl luci-app-uhttpd luci-app-firewall luci-app-package-manager \
            luci-theme-bootstrap luci-compat dnsmasq-full ppp-mod-pppoe \
            luci-app-openclash kmod-wireguard wireguard-tools luci-proto-wireguard \
            ddns-scripts-cloudflare luci-app-ddns \
            speedtest-go speedtest-netperf netperf fping mtr-json iperf3 \
            luci-app-statistics luci-app-nlbwmon luci-app-vnstat2 vnstat2 vnstati2
          do
            grep -q "^${p} " "$MANIFEST" || { echo "MISSING in manifest: $p"; exit 1; }
          done
          echo "MANIFEST CHECK: PASS"

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: /tmp/build.log
          if-no-files-found: ignore

      - name: Upload firmware
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-x86-64-24.10.5
          path: |
            ${{ env.IB_DIR }}/bin/targets/x86/64/*combined*.img.gz
            ${{ env.IB_DIR }}/bin/targets/x86/64/sha256sums
